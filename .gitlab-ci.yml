---
stages:
  - build
  - test

umit:
  stage: build
  script:
    - git submodule update --init
    - docker build -t umit/ubuntu:$(git rev-parse HEAD) .
  tags:
    - linux
    - docker

test:
  stage: test
  script:
    - docker run --workdir /home/gitlab-ci/umit umit/ubuntu:$(git rev-parse HEAD) bash run_tests.sh
    - docker cp $(docker ps -a |grep $(git rev-parse HEAD)|grep "bash run_tests.sh"|head -n1|cut -d" " -f 1):/home/gitlab-ci/umit/build/install - > umit-$(git rev-parse HEAD).tar
    - gzip -9 umit-$(git rev-parse HEAD).tar
  dependencies:
    - umit
  artifacts:
    paths:
      - umit-*.tar.gz
